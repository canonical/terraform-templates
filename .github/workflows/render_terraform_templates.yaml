name: Render Terraform templates
on:
  workflow_dispatch:
    inputs:
      env_name:
        description: 'Environment Name'
        required: true
        type: string
      env_owner:
        description: 'Environment Owner'
        required: true
        type: string
      env_cloud:
        description: 'Environment Cloud'
        default: 'ps6'
        type: choice
        options:
          - 'ps5'
          - 'ps6'
      env_stage:
        description: 'Environment Stage'
        default: 'staging'
        type: choice
        options:
          - 'staging'
          - 'production'
      application_name:
        description: 'Application Name'
        required: true
        type: choice
        options:
          - 'base'
          - 'hello-kubecon'
          - 'synapse'
      application_type:
        description: 'Application type'
        default: 'k8s'
        type: choice
        options:
          - 'k8s'
          - 'machine'
  workflow_call:
    inputs:
      env_name:
        required: true
        description: 'Environment Name'
        type: string
      env_owner:
        description: 'Environment Owner'
        required: true
        type: string
      env_cloud:
        description: 'Environment Cloud (ps5 or ps6)'
        default: 'ps6'
        type: string
      env_stage:
        description: 'Environment Stage'
        default: 'staging'
        type: string
      application_name:
        description: 'Application Name. E.g.: base, hello-kubecon'
        required: true
        type: string
      application_type:
        description: 'Application type (k8s or machine)'
        default: 'k8s'
        type: string
    outputs:
      pr_url:
        description: "URL to the raised Pull Request"
        value: ${{ jobs.create_environment_terraform.outputs.pr_url }}

env:
  WORKING_DIR: terraform-templates/terraform
  TEMPLATE_DIR: terraform-templates/templates/${{ inputs.application_type }}
  REPO_NAME: is-${{ inputs.env_name}}

jobs:
  create_environment_terraform:
    name: Create Environment Terraform
    runs-on: ubuntu-latest
    outputs:
      pr_url: ${{ steps.create_pull_request.outputs.pr_url }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          repository: canonical/terraform-templates
          path: terraform-templates
          token: ${{ secrets.REPO_ACCESS_TOKEN }}

      - name: Create working directory and files
        run: |
          mkdir ${{ env.WORKING_DIR }}
          cd ${{ env.WORKING_DIR }}
          touch backend.tf main.tf versions.tf variables.tf providers.tf

      - name: Setup backend.tf
        uses: cuchi/jinja2-action@v1.2.2
        with:
          template: ${{ env.TEMPLATE_DIR }}/base/backend.tf.j2
          output_file: ${{ env.WORKING_DIR }}/backend.tf
          strict: true
          variables: |
            env_cloud=${{ inputs.env_cloud }}
            env_name=${{ inputs.env_name }}
            env_owner=${{ inputs.env_owner }}

      - name: Setup versions
        uses: cuchi/jinja2-action@v1.2.2
        with:
          template: ${{ env.TEMPLATE_DIR }}/base/versions.tf.j2
          output_file: ${{ env.WORKING_DIR }}/versions.tf
          strict: true
          variables: |
            env_name=${{ inputs.env_name }}

      - name: Setup variables
        uses: cuchi/jinja2-action@v1.2.2
        with:
          template: ${{ env.TEMPLATE_DIR }}/base/variables.tf.j2
          output_file: ${{ env.WORKING_DIR }}/variables.tf
          strict: true
          variables: |
            env_name=${{ inputs.env_name }}

      - name: Setup providers
        uses: cuchi/jinja2-action@v1.2.2
        with:
          template: ${{ env.TEMPLATE_DIR }}/base/providers.tf.j2
          output_file: ${{ env.WORKING_DIR }}/providers.tf
          strict: true
          variables: |
            env_stage=${{ inputs.env_stage }}
            env_cloud=${{ inputs.env_cloud }}
            env_name=${{ inputs.env_name }}

      - name: Setup application
        uses: cuchi/jinja2-action@v1.2.2
        with:
          template: ${{ env.TEMPLATE_DIR }}/${{ inputs.application_name }}/main.tf.j2
          output_file: ${{ env.WORKING_DIR }}/main.tf
          strict: true
          variables: |
            env_name=${{ inputs.env_name }}

      - name: Set identity
        run: |
          git config --global user.email "canonical-is-bot@canonical.com"
          git config --global user.name "Canonical IS Bot"

      - name: Checkout env repo
        uses: actions/checkout@v4
        with:
          repository: canonical/${{env.REPO_NAME}}
          path: remote-repo
          token: ${{ secrets.REPO_ACCESS_TOKEN }}

      - name: Commit and push changes
        working-directory: remote-repo
        run: |
          GIT_HASH=$(git rev-parse --short "$GITHUB_SHA")
          BRANCH="terraform-template-${{ inputs.env_name }}-${GIT_HASH}"
          echo "BRANCH=${BRANCH?}" >> "$GITHUB_ENV"
          git checkout -b ${BRANCH?}
          cp -rT ../${{ env.WORKING_DIR }} .
          curl -Lo ./terraform-docs.tar.gz https://github.com/terraform-docs/terraform-docs/releases/download/v0.17.0/terraform-docs-v0.17.0-$(uname)-amd64.tar.gz
          tar -xzf terraform-docs.tar.gz -C /tmp/ && rm -f terraform-docs.tar.gz
          chmod +x /tmp/terraform-docs
          /tmp/terraform-docs markdown ./ --output-file README.md --output-mode replace
          git add .
          git commit -m "Add terraform project template for ${{ inputs.env_name }}"
          # git remote set-url origin https://${{ secrets.REPO_ACCESS_TOKEN }}:x-oauth-basic@github.com/canonical/${{ env.REPO_NAME }}.git
          git remote -v
          git push -v origin ${BRANCH?}
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}

      - name: Create pull request
        id: create_pull_request
        run: |
          PR_URL=$(gh pr create --repo canonical/${{ env.REPO_NAME }} -B main -H "canonical:${BRANCH?}" --title "[AUTO] Add terraform project template for ${{ inputs.env_name }}" --body 'Created by Github action')
          echo "pr_url=${PR_URL}" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}

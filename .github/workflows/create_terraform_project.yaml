name: Create Terraform Project
on:
  workflow_dispatch:
    inputs:
      service_name:
        description: 'Name of service (model name and repository name)'
        required: true
        type: string
      service_owner:
        description: 'Owner of service'
        required: true
        type: string
      service_cloud:
        description: 'Service Cloud'
        default: 'ps6'
        type: choice
        options:
          - 'ps5'
          - 'ps6'
      service_region:
        description: 'Service Region'
        default: 'ps6'
        type: choice
        options:
          - 'ps5'
          - 'ps6'
      environment_stage:
        description: 'Service stage'
        required: true
        default: 'staging'
        type: choice
        options:
          - 'staging'
          - 'production'
      application_name:
        description: 'Name of Application. E.g.: hello-kubecon'
        required: true
        type: string
      application_type:
        description: 'Application type'
        default: 'k8s'
        type: choice
        options:
          - 'k8s'
          - 'machine'


jobs:
  render_templates:
    name: Render templates
    runs-on: ubuntu-latest
    outputs:
      templates_result: ${{ steps.templates_result.outputs.templates_result }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      - name: Create working directory
        run: |
          mkdir ${{ inputs.environment_stage }}
          touch ${{ inputs.environment_stage }}/backend.tf
          touch ${{ inputs.environment_stage }}/locals.tf
          touch ${{ inputs.environment_stage }}/main.tf
      - name: Setup backend.tf
        uses: cuchi/jinja2-action@v1.2.2
        with:
          template: templates/base/backend.tf.j2
          output_file: ${{ inputs.environment_stage }}/backend.tf
          strict: true
          variables: |
            service_cloud=${{ inputs.service_cloud }}
            service_name=${{ inputs.service_name }}
            service_owner=${{ inputs.service_owner }}
            service_region=${{ inputs.service_region }}
      - name: Setup locals.tf
        uses: cuchi/jinja2-action@v1.2.2
        with:
          template: templates/base/locals.tf.j2
          output_file: ${{ inputs.environment_stage }}/locals.tf
          strict: true
          variables: |
            service_cloud=${{ inputs.service_cloud }}
            service_name=${{ inputs.service_name }}
      - name: Setup application
        uses: cuchi/jinja2-action@v1.2.2
        with:
          template: templates/${{ inputs.application_type }}/${{ inputs.application_name }}/main.tf.j2
          output_file: ${{ inputs.environment_stage }}/main.tf
          strict: true
      - name: Print templates result to output
        id: templates_result
        run: |
          TEMPLATES_RESULT=$(cat ${{ inputs.environment_stage }}/*.tf)
          echo "templates_result='${TEMPLATES_RESULT}'" >> $GITHUB_OUTPUT

{#- CMDB: Controller addresses should be stored in a CMDB, not here. #}
{% filter trim %}
{% if env_stage == "production" %}
{%     if env_cloud == "ps5" %}
{%         set controller = "juju-controller-34-production-ps5" %}
{%         set controller_addresses = "juju-controller-34-production-ps5.admin.canonical.com:17070" %}
{%     elif env_cloud == "ps6" %}
{%         set controller = "juju-controller-34-production-ps6" %}
{%         set controller_addresses = "juju-controller-34-production-ps6.admin.canonical.com:17070" %}
{%     endif %}
{% elif env_stage == "staging" %}
{%     if env_cloud == "ps5" %}
{%         set controller = "juju-controller-34-staging-ps5" %}
{%         set controller_addresses = "juju-controller-34-staging-ps5.admin.canonical.com:17070" %}
{%     elif env_cloud == "ps6" %}
{%         set controller = "juju-controller-34-staging-ps6" %}
{%         set controller_addresses = "juju-controller-34-staging-ps6.admin.canonical.com:17070" %}
{%     endif %}
{% endif %}
{% if env_cloud == "ps5" %}
{%     set env_region = "prodstack5" %}
{% elif env_cloud == "ps6" %}
{%     set env_region = "prodstack6" %}
{% endif %}
provider "vault" {
  address = "https://vault.admin.canonical.com:8200"
  auth_login {
    path = "auth/approle/login"

    parameters = {
      role_id   = var.approle_role_id
      secret_id = var.approle_secret_id
    }
  }
}

data "vault_generic_secret" "juju_credentials" {
  path = "secret/{{ env_region }}/roles/{{ env_name }}/juju"
}

data "vault_generic_secret" "juju_controller_certificate" {
  path = "secret/{{ env_region }}/juju/common/ca_certs/{{ controller }}"
}

provider "juju" {
  controller_addresses = "{{ controller_addresses }}"
  ca_certificate       = data.vault_generic_secret.juju_controller_certificate.data["ca_cert"]
  username             = data.vault_generic_secret.juju_credentials.data["username"]
  password             = data.vault_generic_secret.juju_credentials.data["password"]
}
{% endfilter %}

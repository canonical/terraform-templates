{#- CMDB: Controller addresses should be stored in a CMDB, not here. #}
{% if env_stage == "production" %}
{%     if env_cloud == "ps5" %}
{%         set controller_addresses = "10.131.1.106:17070,10.131.1.80:17070,10.131.1.171:17070" %}
{%     elif env_cloud == "ps6" %}
{%         set controller_addresses = "10.141.22.89:17070,10.141.22.175:17070,10.141.22.167:17070" %}
{%     endif %}
{% elif env_stage == "staging" %}
{%     if env_cloud == "ps5" %}
{%         set controller_addresses = "10.131.3.163:17070,10.131.3.171:17070,10.131.3.230:17070" %}
{%     elif env_cloud == "ps6" %}
{%         set controller_addresses = "10.141.19.106:17070,10.141.19.29:17070,10.141.19.30:17070" %}
{%     endif %}
{% endif %}
{% if env_cloud == "ps5" %}
{%     set env_region = "prodstack5" %}
{% elif env_cloud == "ps6" %}
{%     set env_region = "prodstack6" %}
{% endif %}
provider "vault" {
  address = "https://vault.admin.canonical.com:8200"
  auth_login {
    path = "auth/approle/login"

    parameters = {
      role_id   = var.approle_role_id
      secret_id = var.approle_secret_id
    }
  }
}

data "vault_generic_secret" "{{ env_region }}-credentials" {
  path = "secret/{{ env_region }}/admin/openstack-credentials"
}

data "vault_generic_secret" "ldap-credentials" {
  path = "secret/ldap/is-terraform"
}

data "vault_generic_secret" "juju-controller-credentials-{{ env_stage }}" {
  path = "secret/{{ env_region }}/admin/juju-controller/{{ env_stage }}"
}

provider "openstack" {
  user_name           = data.vault_generic_secret.{{ env_region }}-credentials.data["username"]
  password            = data.vault_generic_secret.{{ env_region }}-credentials.data["password"]
  tenant_name         = "admin"
  auth_url            = "https://keystone.{{ env_cloud }}.canonical.com:5000/v3"
  project_domain_name = "admin_domain"
  user_domain_name    = "admin_domain"
}

provider "ldap" {
  ldap_host     = "erinyes.canonical.com"
  ldap_port     = 636
  tls           = true
  bind_user     = data.vault_generic_secret.ldap-credentials.data["user_dn"]
  bind_password = data.vault_generic_secret.ldap-credentials.data["password"]
}

data "vault_generic_secret" "juju-credentials" {
  path = "secret/{{ env_region }}/roles/{{ env_name }}/juju"
}

data "vault_generic_secret" "juju-controller-certificate" {
  path = "secret/{{ env_region }}/juju/common/ca_certs/prodstack-is"
}

provider "juju" {
  # These addresses refer to the {{ env_cloud }} controller for {{ env_stage }} environments
  controller_addresses = "{{ controller_addresses }}"
  ca_certificate       = data.vault_generic_secret.juju-controller-credentials-{{ env_stage }}.data["ca_cert"]
  username             = data.vault_generic_secret.juju-controller-credentials-{{ env_stage }}.data["username"]
  password             = data.vault_generic_secret.juju-controller-credentials-{{ env_stage }}.data["password"]
}

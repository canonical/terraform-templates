{#- CMDB: Controller addresses should be stored in a CMDB, not here. #}
{% filter trim %}
{% if env_stage == "production" %}
{%     if env_cloud == "ps5" %}
{%         set controller_addresses = "10.131.1.106:17070,10.131.1.80:17070,10.131.1.171:17070" %}
{%     elif env_cloud == "ps6" %}
{%         set controller_addresses = "10.141.22.89:17070,10.141.22.175:17070,10.141.22.167:17070" %}
{%     endif %}
{% elif env_stage == "staging" %}
{%     if env_cloud == "ps5" %}
{%         set controller_addresses = "10.131.3.163:17070,10.131.3.171:17070,10.131.3.230:17070" %}
{%     elif env_cloud == "ps6" %}
{%         set controller_addresses = "10.141.19.106:17070,10.141.19.29:17070,10.141.19.30:17070" %}
{%     endif %}
{% endif %}
{% if env_cloud == "ps5" %}
{%     set env_region = "prodstack5" %}
{% elif env_cloud == "ps6" %}
{%     set env_region = "prodstack6" %}
{% endif %}
provider "vault" {
  address = "https://vault.admin.canonical.com:8200"
  auth_login {
    path = "auth/approle/login"

    parameters = {
      role_id   = var.approle_role_id
      secret_id = var.approle_secret_id
    }
  }
}

data "vault_generic_secret" "juju-credentials" {
  path = "secret/{{ env_region }}/roles/{{ env_name }}/juju"
}

data "vault_generic_secret" "juju-controller-certificate" {
  path = "secret/{{ env_region }}/juju/common/controller_ca_certs/{{ env_stage }}"
}

provider "juju" {
  # These addresses refer to the {{ env_cloud }} controller for {{ env_stage }} environments
  controller_addresses = "{{ controller_addresses }}"
  ca_certificate       = data.vault_generic_secret.juju-controller-certificate.data["ca_cert"]
  username             = data.vault_generic_secret.juju-credentials.data["username"]
  password             = data.vault_generic_secret.juju-credentials.data["password"]
}
{% endfilter %}
